# 自然語言記帳 & 待辦邏輯參考文件

> 此文件為 AI 開發者參考用，描述「自然語言輸入 → 記帳 / 待辦」的完整解析邏輯與資料結構。

---

## 一、輸入分類（detectKind）

使用者在同一個輸入框打文字，系統先判斷這是「記帳」還是「待辦」：

```js
const detectKind = text => {
  // 有數字 + 金額單位 → 記帳
  if (/(\d+(?:\.\d+)?)\s*(?:元|塊|块|円)|(?:NT\$|\$)\s*\d+/.test(text)) return 'expense';
  // 收入關鍵字 → 記帳
  if (/收到|薪水|薪資|工資|月薪|獎金|賺到?|領到|入帳/.test(text)) return 'expense';
  // 消費動詞 + 數字 → 記帳
  if (/花了?|付了?|消費了?|花費了?/.test(text) && /\d/.test(text)) return 'expense';
  // 飲食/交通/購物情境關鍵字 + 數字 → 記帳（例如「午餐100」）
  if (/吃|喝|餐|飯|麵|便當|咖啡|奶茶|飲料|早餐|午餐|晚餐|宵夜|早午餐|甜點|下午茶|點心|火鍋|炸雞|珍奶|蛋糕|麵包|壽司|拉麵|牛排|燒烤|超市|賣場|加油|停車|捷運|公車|計程車|電影|買/.test(text) && /\d/.test(text)) return 'expense';
  // 其他 → 待辦
  return 'todo';
};
```

---

## 二、記帳解析器（NLExpense）

### 呼叫方式

```js
const result = NLExpense.parse("昨天午餐花了80塊");
// result = { amount: 80, type: 'expense', category: '餐飲', date: '2024-03-14', note: '午餐' }
```

返回 `null` 表示無法識別金額。

### 解析步驟

#### 1. 金額提取（優先順序）

```
數字 + 元/塊/块/円  >  NT$/$ + 數字  >  文字中最大的裸數字
```

```js
const ww = text.match(/(\d+(?:\.\d{1,2})?)\s*(?:元|塊|块|円)/);
const ws = text.match(/(?:NT\$|\$)(\d+(?:\.\d{1,2})?)/);
// 兩者都沒有 → 取文字中最大的數字
```

#### 2. 收支類型判斷

預設為 `expense`，若包含以下關鍵字改為 `income`：

```
收到、收入、薪水、薪資、工資、月薪、獎金、紅利、
退款、退稅、利息、股息、分紅、賺、領到、入帳
```

#### 3. 日期解析（NLExpense.parseDate）

依序嘗試：

| 規則 | 範例 | 說明 |
|------|------|------|
| 相對日關鍵字 | 今天、昨天、前天、明天、後天、大前天 | 加/減天數偏移 |
| 上週星期X | 上週三、上個禮拜五 | subtract(1, 'week').day(X) |
| 這週/本週X | 這週一、本週四 | 本週第X天 |
| 下週X | 下週二 | add(1, 'week').day(X) |
| X月X日/號 | 3月15日、3月15號 | 若超過今天2個月則視為去年 |
| X/X | 3/15 | 同上邏輯，排除時間格式 |
| 無匹配 | — | 預設今天 |

`parseDate` 回傳 `{ date: 'YYYY-MM-DD', matched: string | null }`，`matched` 是從原文中抓到的日期字串，用於後續清除。

#### 4. 分類偵測（支出）

關鍵字規則，第一個命中的分類獲勝，都沒中則為「其他」：

```
餐飲：吃、喝、餐、飯、麵、便當、咖啡、奶茶、早餐、午餐、晚餐、宵夜、飲料、
      火鍋、炸雞、珍奶、滷味、蛋糕、麵包、壽司、拉麵、牛排、燒烤、甜點、下午茶、早午餐、點心

交通：捷運、公車、火車、高鐵、計程車、uber、油錢、停車、加油、機票、台鐵、
      高速、過路費、mrt、bus、腳踏車、gogoro、汽車

購物：衣服、鞋子、包包、手機、電腦、3c、超市、賣場、百貨、蝦皮、amazon、
      服飾、飾品、筆電、耳機、充電器、家電、傢俱、日用品

娛樂：電影、ktv、遊戲、音樂、演唱會、展覽、漫畫、netflix、spotify、youtube、
      夜店、酒吧、桌遊、密室、健身、游泳、電玩、livehouse、書

醫療：醫院、診所、藥局、藥、掛號、看診、牙醫、健保、保險、眼科、復健

住房：房租、水電、瓦斯、網路費、管理費、電費、水費、租金、寬頻、第四台

教育：補習、課程、學費、書本、教材、考試、證照、線上課
```

#### 5. 分類偵測（收入）

```
薪水：薪水、薪資、工資、月薪、底薪
兼職：兼職、打工、案子、接案、外快、freelance
投資：股票、基金、投資、利息、股息、分紅、配息
禮金：紅包、禮金、壓歲錢、獎金、獎勵、退款、退稅
```

#### 6. 備註清理

從原文中移除：金額字串、日期字串、動詞語助詞（花了、付了、買了、收到…），剩下的就是備註。

```js
note = text
  .replace(amountMatched, '')
  .replace(dateMatched, '')
  .replace(/花了?|付了?|買了?|收到|消費了?|花費了?|支出了?|領到|賺了?|支付了?/g, '')
  .trim();
```

---

## 三、待辦解析器（NLTodo）

### 呼叫方式

```js
const result = NLTodo.parse("緊急明天開會");
// result = { text: '開會', priority: 'high', dueDate: '2024-03-15' }
```

### 解析步驟

#### 1. 優先級偵測

```
high（高）：緊急、urgent、重要、ASAP、asap、馬上、立刻、今天要、今天必須
low（低）： 有空、順便、不急、隨時、之後再
medium（中）：其餘（預設）
```

#### 2. 截止日期

只有在文字中偵測到**明確日期關鍵字**（matched 不為 null）才設定 `dueDate`，否則為 `null`。使用 `NLExpense.parseDate` 同一套規則。

#### 3. 文字清理

移除日期字串與優先級關鍵字後，剩下的就是任務標題：

```js
cleanText = cleanText
  .replace(dateMatched, '')
  .replace(/緊急|重要|不急|有空|順便|隨時|之後再/g, '')
  .trim();
```

---

## 四、資料結構

### 帳本（Ledger）

```js
{
  id: 'led_xxx',       // 唯一 ID（Storage.genId('led')）
  name: '日常',        // 帳本名稱，使用者自訂
  createdAt: 1234567890  // timestamp（ms）
}
```

儲存於 localStorage key `pla_ledgers`，陣列格式。

### 記帳記錄（Expense）

```js
{
  id: 'exp_xxx',          // 唯一 ID
  ledgerId: 'led_xxx',    // 所屬帳本 ID
  type: 'expense',        // 'expense' | 'income'
  amount: 150,            // 數字，正值
  category: '餐飲',       // 見下方分類清單
  date: '2024-03-14',     // YYYY-MM-DD
  note: '午餐',           // 備註，可空字串
  createdAt: 1234567890   // timestamp（ms）
}
```

儲存於 localStorage key `pla_expenses`，陣列格式（最新在前）。

**支出分類清單**：餐飲、交通、購物、娛樂、醫療、住房、教育、其他
**收入分類清單**：薪水、兼職、投資、禮金、其他

### 待辦事項（Todo）

```js
{
  id: 'todo_xxx',           // 唯一 ID
  text: '開會',             // 任務標題
  done: false,              // 是否完成
  priority: 'medium',       // 'high' | 'medium' | 'low'
  dueDate: '2024-03-15',    // YYYY-MM-DD，可為 null
  createdAt: 1234567890,    // timestamp（ms）
  completedAt: null         // 完成時的 timestamp，未完成為 null
}
```

儲存於 localStorage key `pla_todos`，陣列格式。

---

## 五、分類圖示對照

```js
{
  餐飲: '🍜', 交通: '🚌', 購物: '🛍️', 娛樂: '🎮', 醫療: '💊',
  住房: '🏠', 教育: '📚', 薪水: '💼', 兼職: '💡', 投資: '📈',
  禮金: '🎁', 其他: '📌',
}
```

---

## 六、待辦列表分組邏輯

顯示時，未完成的任務依截止日分成六組（依序顯示）：

| 群組 | 條件 | 顏色 |
|------|------|------|
| 已過期 | dueDate < 今天 | 紅 #ef4444 |
| 今天 | dueDate === 今天 | 橘 #f59e0b |
| 明天 | dueDate === 明天 | 藍 #3b82f6 |
| 本週 | dueDate <= 本週末 | 紫 #8b5cf6 |
| 之後 | dueDate > 本週末 | 灰 #6b7280 |
| 無期限 | dueDate === null | 淺灰 #9ca3af |

同一群組內，先依優先級排序（high → medium → low），再依建立時間降冪。

已完成的任務固定顯示在最底部（全部篩選時）。

---

## 七、即時預覽（Real-time Preview）

使用者輸入時就即時顯示解析結果，讓使用者確認後再送出。

- 辨識為**記帳**：顯示藍底預覽，格式為 `💰 ✓ [圖示] [分類] [收/支] [金額] · [日期] · [備註]`，附「編輯」按鈕可展開表單修正。
- 辨識為**待辦**：顯示綠底預覽，格式為 `✅ ✓ [任務名稱] · [截止日] · [優先級]`。
- 無法識別金額：顯示橘底警告。

---

## 八、依賴套件

- **dayjs**：所有日期計算與格式化（`YYYY-MM-DD`、`YYYY-MM`、add/subtract/day/isBefore 等）
- **localStorage**：所有資料持久化

---

*此文件由 claude/life-assistant-app-mClrT 自動產生*
